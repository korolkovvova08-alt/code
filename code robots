#include <Servo.h>

Servo myservo;
Servo right;
Servo left;

String buf = "";

int left_percent = 50;
int right_percent = 50;

int percentToMicroseconds(int p) {
  if (p < 0) p = 0;
  if (p > 100) p = 100;
  return 1400 + p * 2;
}

void setLeftPercent(int p) {
  left_percent = constrain(p, 0, 100);
  left.writeMicroseconds(percentToMicroseconds(left_percent));
}

void setRightPercent(int p) {
  right_percent = constrain(p, 0, 100);
  right.writeMicroseconds(percentToMicroseconds(right_percent));
}

void handleSingleChar(char c) {
  switch (c) {
    case 'a':
      right.writeMicroseconds(1500);
      left.writeMicroseconds(1600);
      break;
    case 'd':
      right.writeMicroseconds(1600);
      left.writeMicroseconds(1500);
      break;
    case 'x':
      right.writeMicroseconds(1500);
      left.writeMicroseconds(1500);
      myservo.writeMicroseconds(1500);
      break;
    case 'w':
      right.writeMicroseconds(1600);
      left.writeMicroseconds(1600);
      break;
    case 's':
      right.writeMicroseconds(1400);
      left.writeMicroseconds(1400);
      break;
    case 'q':
      right.writeMicroseconds(1400);
      left.writeMicroseconds(1600);
      break;
    case 'e':
      right.writeMicroseconds(1600);
      left.writeMicroseconds(1400);
      break;
    case 'r':
      myservo.writeMicroseconds(1600);
      break;
    case 't':
      myservo.writeMicroseconds(1450);
      break;
    default:
      break;
  }
}

void parseBuffer(String s) {
  s.trim();
  if (s.length() == 0) return;

  if (s.length() == 1 && !isDigit(s.charAt(0))) {
    handleSingleChar(s.charAt(0));
    return;
  }

  char cmd = s.charAt(0);
  String valstr = s.substring(1);
  int val = valstr.toInt();

  switch (cmd) {
    case 'L':
      setLeftPercent(val);
      break;
    case 'R':
      setRightPercent(val);
      break;
    case 'P':
      val = constrain(val, 0, 180);
      myservo.write(val);
      break;
    default:
      break;
  }
}

void setup() {
  myservo.attach(5);
  right.attach(2);
  left.attach(3);

  Serial.begin(115200);
  Serial.println("Mega: starting. Listening on Serial3 at 9600.");

  Serial3.begin(9600);
  setLeftPercent(50);
  setRightPercent(50);
  myservo.write(90);
}

void loop() {
  while (Serial3.available() > 0) {
    char c = Serial3.read();
    if (c == '\n' || c == '\r') {
      if (buf.length() > 0) {
        parseBuffer(buf);
        Serial.print("Parsed: ");
        Serial.println(buf);
        buf = "";
      }
    } else {
      buf += c;
      if (buf.length() == 1 && !isDigit(buf.charAt(0))) {
        parseBuffer(buf);
        Serial.print("Parsed single: ");
        Serial.println(buf);
        buf = "";
      }
      if (buf.length() > 10) {
        buf = "";
      }
    }
  }
}
